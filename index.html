<!DOCTYPE html>
<html lang="ms-MY">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kemahiran Pemulihan: Operasi Bahagi (Konsep Asas)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .activity-card { min-height: 400px; }
    .number-card { transition: all .3s ease; cursor: pointer; }
    .number-card:hover { transform: scale(1.05); }
    .dragging { opacity: .5; transform: rotate(5deg); }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed #cbd5e1;
      transition: all .3s ease;
      min-width: 60px;
      min-height: 60px;
      display: inline-block;
      vertical-align: middle;
    }
    .drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }

    /* Salah */
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
    .shake { animation: shake 0.5s ease; }

    /* Zon sudah diisi */
    .drop-zone-filled {
      border-style: solid;
      border-color: #4ade80;
      background-color: #f0fdf4;
    }

    /* Gaya Token (Aktiviti 3) */
    .token-on { outline: 3px solid #A78BFA; }
    .token-bad { outline: 3px solid #F87171; }
    .result-good { background: #dcfce7; outline: 3px solid #22c55e; }

    /* === GAYA BAHARU UNTUK AKTIVITI BAHAGI === */
    
    /* Aktiviti 1 (Lompat Katak) */
    .number-line-container {
      display: flex;
      align-items: flex-end;
      padding: 20px;
      background: #f0f9ff;
      border-radius: 12px;
      border: 2px solid #bae6fd;
      position: relative;
      height: 150px;
      overflow: hidden;
    }
    .number-line-track {
      display: flex;
      align-items: flex-end;
      height: 100%;
      width: 100%;
      justify-content: space-between;
    }
    .number-tick {
      flex-grow: 1;
      flex-basis: 0;
      text-align: center;
      border-bottom: 4px solid #0ea5e9;
      padding-bottom: 5px; font-weight: 600;
      position: relative;
    }
    .number-tick::before {
      content: '';
      position: absolute;
      bottom: 0; left: 50%;
      width: 2px; height: 10px;
      background: #0ea5e9;
    }
    .frog {
      font-size: 4rem;
      position: absolute;
      bottom: 30px;
      left: 0; /* Dikawal oleh JS */
      transition: left 0.5s ease;
      transform: translateX(-50%);
    }

    /* Aktiviti 2 (Domino) */
    .domino-question, .domino-answer {
      border: 2px solid #fb923c;
      background: #fff7ed;
      color: #c2410c;
    }
    .domino-question { min-width: 150px; }
    .domino-answer { cursor: move; }

    /* Aktiviti 3 (Bina Ayat) */
    .story-box {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      color: #b91c1c;
      border-radius: 12px;
      padding: 1.5rem;
      font-size: 1.25rem;
      font-weight: 600;
    }

    /* Aktiviti 4 & 5 (Agih & Kumpul) */
    .item-basket, .item-line {
      min-height: 120px;
      background: #f0fdf4;
      border-radius: 12px;
    }
    .item-line { background: #f0f9ff; }
    .item-card {
      font-size: 1.5rem;
      width: 80px; height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    .item-person {
      font-size: 4rem;
      width: 100px;
      text-align: center;
      border-radius: 12px;
      padding-top: 10px;
      padding-bottom: 10px;
    }
    
    /* GAYA BARU (Jom Kumpul) */
    .kumpul-box {
      border: 2px solid #93c5fd; /* Sempadan kotak */
      background: #eff6ff;
      border-radius: 8px;
      padding: 8px;
      margin: 4px;
      min-height: 100px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    .box-label {
      width: 100%;
      text-align: center;
      font-weight: bold;
      color: #1d4ed8;
      margin-top: 5px;
    }

  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-full">

  <div class="bg-yellow-100 border-b-4 border-yellow-300 p-4 shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üìö</span>
        <span id="info-text" class="text-lg font-semibold text-gray-800">
          Pilih aktiviti untuk mula belajar bahagi!
        </span>
      </div>
      <button id="speak-btn"
              class="bg-yellow-300 hover:bg-yellow-400 text-yellow-800 font-bold py-2 px-4 rounded-full text-xl transition-colors duration-200"
              onclick="speakInfo()">
        üîä
      </button>
    </div>
  </div>

  <div class="max-w-6xl mx-auto p-6">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6 activity-card flex items-center justify-center">
      <div id="activity-content" class="text-center w-full">
        <div class="py-16">
          <div class="text-6xl mb-4">‚ûó</div>
          <h2 class="text-3xl font-bold text-gray-800 mb-4">
            Kemahiran Pemulihan: Operasi Bahagi (Konsep Asas)
          </h2>
          <p class="text-xl text-gray-600 mb-8">
            Pilih aktiviti di bawah untuk meneroka konsep bahagi secara santai.
          </p>
          <div class="text-4xl">üëá</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Pilih Aktiviti</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <button onclick="loadActivity(1)"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors duration-200">
          üê∏ Lompat Katak
        </button>
        <button onclick="loadActivity(2)"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors duration-200">
          üß© Padan Domino
        </button>
        <button onclick="loadActivity(3)"
                class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors duration-200">
          ‚úçÔ∏è Bina Ayat
        </button>
        <button onclick="loadActivity(4)"
                class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors duration-200">
          üéØ Jom Agih!
        </button>
        <button onclick="loadActivity(5)"
                class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors duration-200">
          üì¶ Jom Kumpul!
        </button>
      </div>

      <div class="flex justify-center gap-4">
        <button onclick="clearActivity()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg text-lg transition-colors duration-200">
          üßπ Bersih
        </button>
        <button onclick="nextActivity()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg text-lg transition-colors duration-200">
          ‚û°Ô∏è Seterusnya
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentActivity = 0;
    let ttsEnabled = false;
    let currentInfo = "Pilih aktiviti untuk mula belajar bahagi!";
    let draggedElement = null;

    // State untuk permainan baharu (KEKAL)
    window.frogGame = { current: 18, target: 0, step: 3, jumps: 0, max: 18 };
    window.agihGame = { };
    window.kumpulGame = { };

    /* ====== TTS (KEKAL SAMA) ====== */
    function speak(text) {
      if (!ttsEnabled) return;
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      setTimeout(() => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ms-MY';
        u.rate = 0.9; u.pitch = 1.05;
        const voices = window.speechSynthesis.getVoices();
        const ms = voices.find(v => v.lang === 'ms-MY' || v.lang?.startsWith('ms'));
        if (ms) u.voice = ms;
        window.speechSynthesis.speak(u);
      }, 100);
    }
    function setInfo(text) { currentInfo = text; document.getElementById('info-text').textContent = text; }
    function speakInfo() {
      if (!ttsEnabled) {
        ttsEnabled = true;
        const btn = document.getElementById('speak-btn');
        btn.classList.add('bg-green-300', 'hover:bg-green-400');
        btn.classList.remove('bg-yellow-300', 'hover:bg-yellow-400');
      }
      speak(currentInfo);
    }

    /* ====== DnD helpers (KEKAL SAMA) ====== */
    function dragStart(e) { draggedElement = e.target; e.target.classList.add('dragging'); }
    function dragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('drag-over')); }
    function allowDrop(e) { e.preventDefault(); if (e.currentTarget.classList.contains('drop-zone')) e.currentTarget.classList.add('drag-over'); }
    function dragLeave(e) { if (e.currentTarget.classList.contains('drop-zone')) e.currentTarget.classList.remove('drag-over'); }

    /* ====== Router (KEKAL) ====== */
    function loadActivity(n) {
      currentActivity = n;
      const content = document.getElementById('activity-content');
      if (n === 1) return loadLompatActivity(content);
      if (n === 2) return loadDominoActivity(content);
      if (n === 3) return loadBinaAyatActivity(content);
      if (n === 4) return loadAgihActivity(content);
      if (n === 5) return loadKumpulActivity(content);
    }

    /* ====== Aktiviti 1: Lompat Katak (FORMULA DIBAIKI) ====== */
    
    // Fungsi helper untuk formula katak
    function getFrogPercent(current, max) {
      // (100 / (Jumlah Tick)) * (Tick Semasa + 0.5 untuk ke tengah)
      const numTicks = max + 1; // 19 ticks (0 to 18)
      return (100 / numTicks) * (current + 0.5);
    }

    function loadLompatActivity(content) {
      window.frogGame = { current: 18, target: 0, step: 3, jumps: 0, max: 18 };
      const infoMsg = "Jom selesaikan 18 √∑ 3. Klik butang 'LOMPAT -3' sehingga katak sampai ke sifar.";
      setInfo(infoMsg);
      
      let numberTicks = '';
      for (let i = 0; i <= window.frogGame.max; i++) {
        numberTicks += `<div class="number-tick">${i}</div>`;
      }
      
      // FORMULA DIBAIKI: Set kedudukan awal katak
      const startPercent = getFrogPercent(window.frogGame.current, window.frogGame.max);

      content.innerHTML = `
        <h3 class="text-2xl font-bold text-blue-600 mb-6">üê∏ Lompat Katak (Tolak Berturut-turut)</h3>
        <div class="mb-4">
          <div class="text-4xl font-bold text-center mb-4">${window.frogGame.current} √∑ ${window.frogGame.step} = <span id="jump-count" class="text-blue-600">?</span></div>
        </div>
        <div class="number-line-container">
          <div class="number-line-track">
            ${numberTicks}
          </div>
          <div id="frog" class="frog" style="left: ${startPercent}%;">üê∏</div>
        </div>
        <div class="text-center mt-6">
          <button id="jump-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-lg text-2xl transition-colors duration-200"
                  onclick="jumpFrog()">
            LOMPAT -${window.frogGame.step}
          </button>
        </div>
      `;
    }
    
    function jumpFrog() {
      let { current, step, jumps, max } = window.frogGame;
      if (current <= 0) return; // Sudah di sifar

      current -= step;
      if (current < 0) current = 0; // Pastikan ia mendarat di 0
      jumps++;
      window.frogGame.current = current;
      window.frogGame.jumps = jumps;

      // Update UI
      const frogEl = document.getElementById('frog');
      const jumpCountEl = document.getElementById('jump-count');
      const jumpBtn = document.getElementById('jump-btn');

      // FORMULA DIBAIKI: Kira kedudukan baru
      const newPercent = getFrogPercent(current, max);
      frogEl.style.left = `${newPercent}%`;
      
      jumpCountEl.textContent = jumps;

      let msg = `Lompat ${jumps}. Sekarang di ${current}.`;
      
      if (current <= 0) {
        msg = `Syabas! Anda perlukan ${jumps} lompatan untuk sampai ke sifar. Jadi, 18 √∑ 3 = ${jumps}.`;
        jumpBtn.disabled = true;
        jumpBtn.classList.add('opacity-50');
      }
      setInfo(msg); speak(msg);
    }

    /* ====== Aktiviti 2: Padan Domino (KEKAL) ====== */
    function loadDominoActivity(content) {
      setInfo("Seret jawapan (kuning) ke soalan (biru) yang betul.");
      
      content.innerHTML = `
        <h3 class="text-2xl font-bold text-green-600 mb-6">üß© Padan Domino</h3>
        <div class="flex flex-col md:flex-row justify-around gap-6">
          
          <div class="w-full md:w-1/3">
            <h4 class="text-lg font-semibold mb-3 text-center">Pilih Jawapan:</h4>
            <div id="number-choices" class="flex flex-col items-center gap-4">
              ${[3, 4, 5].sort(()=>Math.random()-0.5).map(num => `
                <div class="number-card domino-answer bg-yellow-100 border-2 border-yellow-300 rounded-lg p-6 text-3xl font-bold text-yellow-800"
                     draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" data-number="${num}">
                  ${num}
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="w-full md:w-2/3">
            <h4 class="text-lg font-semibold mb-3 text-center">Letakkan di Sini:</h4>
            <div id="domino-line" class="flex flex-col items-center gap-4">
              <div class="domino-question flex items-center justify-between gap-4 p-4 rounded-lg text-2xl font-bold">
                <span>12 √∑ 4 =</span>
                <div class="drop-zone rounded-lg p-4 text-2xl font-bold" ondrop="dropOnDomino(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)" data-correct="3">__</div>
              </div>
              <div class="domino-question flex items-center justify-between gap-4 p-4 rounded-lg text-2xl font-bold">
                <span>20 √∑ 5 =</span>
                <div class="drop-zone rounded-lg p-4 text-2xl font-bold" ondrop="dropOnDomino(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)" data-correct="4">__</div>
              </div>
              <div class="domino-question flex items-center justify-between gap-4 p-4 rounded-lg text-2xl font-bold">
                <span>15 √∑ 3 =</span>
                <div class="drop-zone rounded-lg p-4 text-2xl font-bold" ondrop="dropOnDomino(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)" data-correct="5">__</div>
              </div>
            </div>
          </div>
          
        </div>
      `;
    }
    function dropOnDomino(e) { // (KEKAL)
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      if (!draggedElement) return;
      const draggedNumber = draggedElement.dataset.number;
      const correctNumber = e.currentTarget.dataset.correct;
      if (draggedNumber === correctNumber) {
        e.currentTarget.innerHTML = draggedNumber;
        e.currentTarget.classList.add('drop-zone-filled');
        e.currentTarget.classList.remove('drop-zone');
        e.currentTarget.removeAttribute('ondrop');
        
        draggedElement = null;
        
        const msg = `Betul! ${e.currentTarget.parentElement.querySelector('span').textContent} ${draggedNumber}.`;
        setInfo(msg); speak(msg);
        if (document.querySelectorAll('#domino-line .drop-zone').length === 0) { 
          setInfo("Syabas! Semua domino lengkap!"); speak("Syabas! Semua domino lengkap!"); 
        }
      } else {
        setInfo(`Bukan di situ. Cuba lagi.`); speak(`Bukan di situ. Cuba lagi.`);
        e.currentTarget.classList.add('shake'); setTimeout(()=>e.currentTarget.classList.remove('shake'),500);
      }
    }

    /* ====== Aktiviti 3: Bina Ayat (KEKAL) ====== */
    function loadBinaAyatActivity(content) {
      setInfo("Lihat cerita. Klik token untuk bina ayat matematik yang betul.");

      const problem = {
        story: "Ali ada 15 biji guli. Dia agihkan sama rata kepada 3 orang kawannya.",
        tokens: ["15", "√∑", "3", "=", "5"],
        distractors: ["+", "x", "12", "4"]
      };

      const correctTokens = problem.tokens;
      const correctPhrase = correctTokens.join(" ");
      const bank = [...new Set([...correctTokens, ...problem.distractors])].sort(()=>Math.random()-0.5);

      content.innerHTML = `
        <h3 class="text-2xl font-bold text-purple-600 mb-6">‚úçÔ∏è Bina Ayat Matematik</h3>
        <div class="story-box mb-6 text-center">
          <div class="text-4xl mb-2">üßë</div>
          <p>${problem.story}</p>
          <p class="font-bold mt-2">Bina ayat matematik untuk kiraan ini.</p>
        </div>
        <div class="mb-4">
          <div class="text-sm font-semibold text-gray-600 mb-1">Ayat matematik dibina:</div>
          <div id="b-result" class="min-h-[3.2rem] flex flex-wrap gap-2 items-center bg-white rounded-xl border-2 border-gray-200 p-3 text-2xl font-bold"></div>
        </div>
        <div>
          <div class="text-sm font-semibold text-gray-600 mb-1">Pilih token:</div>
          <div id="b-bank" class="flex flex-wrap gap-2">
            ${bank.map(w=>`
              <button class="number-card bg-purple-50 border-2 border-purple-200 px-5 py-3 text-2xl font-semibold text-purple-800 rounded-xl" data-token="${w}">${w}</button>
            `).join('')}
          </div>
        </div>
        <div class="mt-6 flex flex-wrap gap-3 justify-center">
          <button id="b-semak" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-xl disabled:opacity-40" disabled>‚úÖ Semak</button>
          <button id="b-undo"  class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-3 rounded-xl">‚Ü©Ô∏è Undur</button>
          <button id="b-clear" class="bg-rose-500 hover:bg-rose-600 text-white px-5 py-3 rounded-xl">üßπ Padam</button>
          <button id="b-new"   class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-xl">üîÑ Soalan Baharu</button>
        </div>
      `;

      const bankEl   = document.getElementById('b-bank');
      const resultEl = document.getElementById('b-result');
      const btnSemak = document.getElementById('b-semak');
      let picked = []; let history = [];

      function render(){
        resultEl.innerHTML = picked.map(w=>`<span class="px-3 py-1 rounded-xl bg-white border-2 border-gray-200">${w}</span>`).join('');
        btnSemak.disabled = picked.length===0;
      }

      bankEl.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const w = btn.dataset.token;
          picked.push(w); history.push(btn);
          btn.disabled = true; btn.classList.add('opacity-60','token-on');
          render();
        });
      });

      btnSemak.addEventListener('click', ()=>{
        const user = picked.join(" ");
        resultEl.classList.remove('shake','result-good');
        bankEl.querySelectorAll('button').forEach(b=>b.classList.remove('token-bad'));
        if(user===correctPhrase){
          resultEl.classList.add('result-good');
          setInfo(`Bagus! Ayat matematik ${correctPhrase} betul.`); speak(`Bagus! Ayat matematik ${correctPhrase} betul.`);
        }else{
          for(let i=0;i<picked.length;i++){
            if(picked[i] !== (correctTokens[i] ?? "")){
              const wrongBtn = history[i];
              if(wrongBtn) wrongBtn.classList.add('token-bad');
              break;
            }
          }
          resultEl.classList.add('shake');
          setInfo("Itu belum tepat. Cuba susun semula token."); speak("Itu belum tepat. Cuba susun semula token.");
        }
      });

      document.getElementById('b-undo').addEventListener('click', ()=>{
        const last = history.pop(); if(!last) return;
        picked.pop(); last.disabled=false; last.classList.remove('opacity-60','token-on','token-bad'); render();
      });
      document.getElementById('b-clear').addEventListener('click', ()=>{
        history.forEach(b=>{ b.disabled=false; b.classList.remove('opacity-60','token-on','token-bad'); });
        picked=[]; history=[]; resultEl.classList.remove('result-good','shake'); render(); setInfo("Padam. Cuba bina semula ayat matematik.");
      });
      document.getElementById('b-new').addEventListener('click', ()=>loadBinaAyatActivity(content));
    }


    /* ====== Aktiviti 4: Jom Agih! (KEKAL - LOGIK SUDAH BETUL) ====== */
    function loadAgihActivity(content) {
      const totalItems = 12;
      const totalPeople = 3;
      
      const infoMsg = `Jom agihkan ${totalItems} biskut kepada ${totalPeople} kawan. Seret biskut ke kawan yang betul (ikut giliran). Mula dengan kawan 1.`;
      setInfo(infoMsg);
      
      window.agihGame = { 
        total: totalItems, 
        people: totalPeople, 
        nextPerson: 0, 
        counts: [0, 0, 0],
        draggedCount: 0 
      };

      content.innerHTML = `
        <h3 class="text-2xl font-bold text-orange-600 mb-6">üéØ Jom Agih! (Pengagihan)</h3>
        
        <div class="mb-8 text-center">
          <h4 class="text-lg font-semibold mb-3">Kawan (Letak di sini):</h4>
          <div class="flex justify-center gap-10">
            <div class="item-person drop-zone" data-person-id="0" ondrop="dropOnPerson(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
              üßë<div id="person-0-items" class="text-sm"></div>
            </div>
            <div class="item-person drop-zone" data-person-id="1" ondrop="dropOnPerson(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
              üßë<div id="person-1-items" class="text-sm"></div>
            </div>
            <div class="item-person drop-zone" data-person-id="2" ondrop="dropOnPerson(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
              üßë<div id="person-2-items" class="text-sm"></div>
            </div>
          </div>
          <div id="agih-result" class="text-xl font-bold mt-4 h-8"></div>
        </div>

        <div>
          <h4 class="text-lg font-semibold mb-3 text-center">Bakul Biskut (Pilih ${totalItems} biskut):</h4>
          <div id="agih-basket" class="flex flex-wrap justify-center gap-4 p-4 item-basket border-2 border-green-200">
            ${Array(totalItems).fill(0).map((_, i) => `
              <div class="number-card item-card bg-orange-100 border-2 border-orange-300 text-orange-800 cursor-move"
                   draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" data-type="cookie">
                üç™
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    function dropOnPerson(e) {
      e.preventDefault(); e.currentTarget.classList.remove('drag-over');
      if (!draggedElement || draggedElement.dataset.type !== 'cookie') return;

      const personId = parseInt(e.currentTarget.dataset.personId);
      const { nextPerson, people, total } = window.agihGame;

      if (personId === nextPerson) {
        draggedElement.remove(); 
        draggedElement = null;
        
        window.agihGame.counts[personId]++;
        window.agihGame.draggedCount++;
        e.currentTarget.querySelector('.text-sm').innerHTML += 'üç™'; 
        
        const newNextPerson = (nextPerson + 1) % people;
        window.agihGame.nextPerson = newNextPerson;
        
        if (window.agihGame.draggedCount < total) {
          const msg = `Betul! Biskut ke-${window.agihGame.draggedCount}. Sekarang, beri kepada kawan ke-${newNextPerson + 1}.`;
          setInfo(msg); speak(msg);
        } else {
          const countPerPerson = window.agihGame.counts[0];
          const msg = `Syabas! ${total} biskut diagih kepada ${people} kawan. Setiap kawan dapat ${countPerPerson} biskut. Jadi, ${total} √∑ ${people} = ${countPerPerson}.`;
          setInfo(msg); speak(msg);
          document.getElementById('agih-result').textContent = `${total} √∑ ${people} = ${countPerPerson}`;
        }
      } else {
        const msg = `Oh! Agih satu-satu. Sekarang giliran kawan ke-${nextPerson + 1}.`;
        setInfo(msg); speak(msg); 
        e.currentTarget.classList.add('shake');
        setTimeout(()=>e.currentTarget.classList.remove('shake'), 500);
      }
    }


    /* ====== Aktiviti 5: Jom Kumpul! (LOGIK & HTML DIUBAH) ====== */
    function loadKumpulActivity(content) {
      const items = Array(12).fill(0).map((_, i) => i + 1); // 1, 2, 3... 12
      const totalItems = 12;
      const groupSize = 4;
      const numBoxes = Math.ceil(totalItems / groupSize); // 12 / 4 = 3 kotak
      
      const infoMsg = `Jom kumpulkan ${totalItems} pisang ini empat-empat. Seret pisang satu-persatu ke ampaian untuk dikira.`;
      setInfo(infoMsg);
      window.kumpulGame = { 
        sequence: items,
        nextCorrect: 1, 
        total: totalItems, 
        groupSize: groupSize,
        numBoxes: numBoxes,
        totalBoxesFilled: 0
      };

      // Bina bekas kotak secara dinamik
      let boxHTML = '';
      for (let i = 1; i <= numBoxes; i++) {
        boxHTML += `<div id="kumpul-box-${i}" class="kumpul-box"></div>`;
      }

      content.innerHTML = `
        <h3 class="text-2xl font-bold text-red-600 mb-6">üì¶ Jom Kumpul! (Pengumpulan)</h3>
        
        <div class="mb-8 text-center">
          <h4 class="text-lg font-semibold mb-3">Ampaian Kiraan (Letak di sini):</h4>
          <div id="kumpul-line" class="flex flex-wrap justify-center items-start gap-2 min-h-32 p-4 drop-zone rounded-lg bg-gray-50"
               ondrop="dropOnKumpulLine(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
            ${boxHTML} </div>
          <div id="kumpul-result" class="text-xl font-bold mt-4 h-8"></div>
        </div>

        <div>
          <h4 class="text-lg font-semibold mb-3 text-center">Longgokan Pisang (Pilih ${totalItems} pisang):</h4>
          <div id="kumpul-basket" class="flex flex-wrap justify-center gap-4 p-4 item-basket border-2 border-green-200">
            ${items.map(num => `
              <div class="number-card item-card bg-red-100 border-2 border-red-300 text-red-800 cursor-move"
                   draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" data-number="${num}">
                üçå
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function dropOnKumpulLine(e) {
      e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if (!draggedElement) return;
      
      const draggedNumber = parseInt(draggedElement.dataset.number);
      const { nextCorrect, total, groupSize, sequence } = window.kumpulGame;

      if (draggedNumber === nextCorrect) {
        
        // Tentukan kotak mana yang perlu diisi
        const boxIndex = Math.floor((nextCorrect - 1) / groupSize) + 1; // (1-1)/4+1=1, (4-1)/4+1=1, (5-1)/4+1=2
        const targetBox = document.getElementById(`kumpul-box-${boxIndex}`);
        
        // Masukkan pisang ke dalam kotak itu
        targetBox.appendChild(draggedElement);
        
        draggedElement.setAttribute('draggable','false');
        draggedElement.classList.remove('cursor-move');
        draggedElement = null;
        
        let msg = `Betul! Pisang ke-${nextCorrect}.`;
        
        // Cek jika kotak penuh
        if (nextCorrect % groupSize === 0) {
          window.kumpulGame.totalBoxesFilled++;
          msg += ` Kotak ${window.kumpulGame.totalBoxesFilled} penuh!`;
          // Tambah label PADA kotak
          targetBox.innerHTML += `<div class="box-label">Kotak ${window.kumpulGame.totalBoxesFilled}</div>`;
        }

        // Cek jika sudah selesai
        if (nextCorrect === total) {
          const totalBoxes = window.kumpulGame.totalBoxesFilled;
          msg = `Syabas! ${total} pisang dikumpul ${groupSize}-${groupSize}. Anda dapat ${totalBoxes} kotak. Jadi, ${total} √∑ ${groupSize} = ${totalBoxes}.`;
          setInfo(msg); speak(msg);
          document.getElementById('kumpul-result').textContent = `${total} √∑ ${groupSize} = ${totalBoxes}`;
          window.kumpulGame.nextCorrect = null;
        } else {
          // Belum selesai, set pisang seterusnya
          window.kumpulGame.nextCorrect = nextCorrect + 1;
          setInfo(msg); speak(msg);
        }
        
      } else {
        const msg = `Oh! Sila kumpul ikut urutan. Sekarang giliran pisang ke-${nextCorrect}.`;
        setInfo(msg); speak(msg); draggedElement.classList.add('shake');
        setTimeout(()=>draggedElement.classList.remove('shake'),500);
      }
    }


    /* ====== Kawalan Umum (KEKAL) ====== */
    function clearActivity() {
      currentActivity = 0;
      document.getElementById('activity-content').innerHTML = `
        <div class="text-center py-16">
          <div class="text-6xl mb-4">‚ûó</div>
          <h2 class="text-3xl font-bold text-gray-800 mb-4">Kemahiran Pemulihan: Operasi Bahagi (Konsep Asas)</h2>
          <p class="text-xl text-gray-600 mb-8">Pilih aktiviti di bawah untuk meneroka konsep bahagi secara santai.</p>
          <div class="text-4xl">üëá</div>
        </div>
      `;
      setInfo("Pilih aktiviti untuk mula belajar bahagi!");
    }
    function nextActivity() {
      if (currentActivity === 0) return loadActivity(1);
      if (currentActivity < 5) return loadActivity(currentActivity + 1);
      return loadActivity(1);
    }

    // Kekalkan TTS resume (KEKAL)
    if ('speechSynthesis' in window) {
      setInterval(() => { if (window.speechSynthesis.paused) window.speechSynthesis.resume(); }, 1000);
    }
  </script>
</body>
</html>
